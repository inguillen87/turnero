// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Global User (Auth)
model User {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String?
  passwordHash String
  globalRole   String     @default("USER") // SUPER_ADMIN, USER
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  tenantLinks TenantUser[]
}

// Tenant / Organization
model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  status    String   @default("active") // active, suspended, demo
  planId    String?
  timezone  String   @default("America/Argentina/Buenos_Aires")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plan          Plan?        @relation(fields: [planId], references: [id])
  users         TenantUser[]
  customers     Customer[]
  professionals Professional[]
  services      Service[]
  locations     Location[]
  appointments  Appointment[]
  messages      Message[]
  availabilityRules AvailabilityRule[]
  usage         TenantUsage[]
  auditLogs     AuditLog[]
  integrations  Integration[]
  channels      Channel[]
  payments      Payment[]
}

// Billing / Features
model Plan {
  id          String   @id @default(cuid())
  name        String   // "Free", "Pro", "Enterprise"
  limits      String   // JSON: { max_users: 5, max_appointments: 100 }
  features    String   // JSON: ["whatsapp", "calendar_sync"]
  priceCents  Int
  currency    String   @default("USD")
  createdAt   DateTime @default(now())

  tenants     Tenant[]
}

model TenantUsage {
  id          String   @id @default(cuid())
  tenantId    String
  month       String   // "2023-10"
  counters    String   // JSON: { appointments: 50, whatsapp_msgs: 120 }
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
}

// User role within a specific Tenant
model TenantUser {
  id        String     @id @default(cuid())
  tenantId  String
  userId    String
  role      String     @default("STAFF") // OWNER, ADMIN, STAFF
  createdAt DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

// Core Domain
model Location {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  address   String?
  createdAt DateTime @default(now())

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  availabilityRules AvailabilityRule[]
  appointments      Appointment[]

  @@index([tenantId])
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  phone     String?
  email     String?
  notes     String?
  createdAt DateTime @default(now())
  lastSeenAt DateTime @default(now())

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  messages     Message[]
  metadata     String?       // JSON: { "state": "SELECT_SERVICE", "temp_data": {...} }

  @@index([tenantId])
}

model Professional {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  specialty String?
  email     String?
  active    Boolean  @default(true)

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  availabilityRules AvailabilityRule[]
  appointments      Appointment[]

  @@index([tenantId])
}

model Service {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  durationMin Int
  priceCents  Int
  active      Boolean @default(true)

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@index([tenantId])
}

model AvailabilityRule {
  id             String   @id @default(cuid())
  tenantId       String
  professionalId String? // Nullable if general rule
  locationId     String?
  dayOfWeek      Int      // 0=Sunday, 1=Monday...
  startTime      String   // "09:00"
  endTime        String   // "17:00"
  slotMinutes    Int      @default(30)
  breakStart     String?  // "13:00"
  breakEnd       String?  // "14:00"

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  professional Professional? @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  location     Location?    @relation(fields: [locationId], references: [id])

  @@index([tenantId, professionalId])
}

model Appointment {
  id             String            @id @default(cuid())
  tenantId       String
  customerId     String
  professionalId String?
  serviceId      String
  locationId     String?
  startAt        DateTime
  endAt          DateTime
  status         String            @default("PENDING") // PENDING, CONFIRMED, CANCELLED, DONE, NO_SHOW
  notes          String?
  source         String            @default("WEB") // WEB, WHATSAPP, MANUAL

  // Payment fields (Legacy/Quick access)
  paymentStatus  String?           @default("PENDING") // PENDING, PAID, REFUNDED
  paymentId      String?           // External Payment ID (e.g. MercadoPago ID)
  paymentLink    String?           // URL for payment
  priceCents     Int?              // Price at the time of booking
  depositAmount  Int?              // Amount required to confirm (if partial)

  createdAt DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  professional Professional? @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service      Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  location     Location?    @relation(fields: [locationId], references: [id])
  messages     Message[]
  payments     Payment[]

  @@index([tenantId, startAt])
}

model Payment {
  id            String   @id @default(cuid())
  tenantId      String
  appointmentId String
  provider      String   // "mercadopago", "stripe"
  status        String   // "PENDING", "PAID", "FAILED", "REFUNDED"
  amountCents   Int
  externalId    String?  // MP Preference ID or Payment ID
  createdAt     DateTime @default(now())

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Channel {
  id        String   @id @default(cuid())
  tenantId  String
  provider  String   // "twilio_whatsapp", "web_demo"
  toAddress String   // "whatsapp:+1415..." or "web_demo_ID"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([toAddress])
  @@index([tenantId])
}

model Message {
  id            String   @id @default(cuid())
  tenantId      String
  appointmentId String?
  channel       String   // "whatsapp", "email", "sms"
  direction     String   // "inbound", "outbound"
  body          String
  status        String   // "sent", "delivered", "read", "failed"
  rawJson       String?  // Store full provider payload
  createdAt     DateTime @default(now())

  customerId    String?
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  customer    Customer?    @relation(fields: [customerId], references: [id])

  @@index([tenantId, createdAt])
}

model Integration {
  id        String   @id @default(cuid())
  tenantId  String
  type      String   // "google_calendar", "whatsapp"
  status    String   // "active", "disconnected"
  config    String?  // JSON: { accessToken, refreshToken, calendarId }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String?  // Nullable if system-wide action
  actorUserId String?
  action      String   // "CREATE_TENANT", "DELETE_APPOINTMENT"
  metadata    String?  // JSON
  createdAt   DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
}
