generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  timezone  String   @default("UTC")
  locale    String   @default("es")
  phone     String?
  address   String?
  createdAt DateTime @default(now())

  users             User[]
  services          Service[]
  staff             Staff[]
  availabilityRules AvailabilityRule[]
  appointments      Appointment[]
  clients           Client[]
  messages          Message[]
  integrations      Integration[]
  auditLogs         AuditLog[]
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String   @unique
  passwordHash String?
  role         String   @default("user") // admin, user
  name         String?
  createdAt    DateTime @default(now())

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  auditLogs AuditLog[]

  @@index([tenantId])
}

model Service {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  durationMin Int
  price       Float
  active      Boolean @default(true)

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]

  @@index([tenantId])
}

model Staff {
  id       String  @id @default(cuid())
  tenantId String
  name     String
  active   Boolean @default(true)

  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  availabilityRules AvailabilityRule[]
  appointments      Appointment[]

  @@index([tenantId])
}

model AvailabilityRule {
  id          String @id @default(cuid())
  tenantId    String
  staffId     String
  dayOfWeek   Int // 0=Sunday, 1=Monday...
  startTime   String // "09:00"
  endTime     String // "17:00"
  slotMinutes Int? // Optional override

  tenant Tenant @relation(fields: [tenantId], references: [id])
  staff  Staff  @relation(fields: [staffId], references: [id])

  @@index([tenantId])
  @@index([staffId])
}

model Appointment {
  id          String   @id @default(cuid())
  tenantId    String
  staffId     String
  serviceId   String
  clientId    String?
  clientName  String?
  clientPhone String?
  startAt     DateTime
  endAt       DateTime
  status      String   @default("pending") // pending, confirmed, cancelled, done, waiting, no_show
  notes       String?
  source      String?  // web, whatsapp, manual

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  staff   Staff    @relation(fields: [staffId], references: [id])
  service Service  @relation(fields: [serviceId], references: [id])
  client  Client?  @relation(fields: [clientId], references: [id])

  @@index([tenantId])
  @@index([staffId])
  @@index([serviceId])
  @@index([clientId])
}

model Client {
  id       String   @id @default(cuid())
  tenantId String
  name     String
  phone    String?
  email    String?
  lastSeen DateTime?

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]
  messages     Message[]

  @@index([tenantId])
}

model Message {
  id        String   @id @default(cuid())
  tenantId  String
  clientId  String?
  channel   String   // whatsapp, sms, email
  direction String   // inbound, outbound
  body      String
  createdAt DateTime @default(now())

  tenant Tenant  @relation(fields: [tenantId], references: [id])
  client Client? @relation(fields: [clientId], references: [id])

  @@index([tenantId])
  @@index([clientId])
}

model Integration {
  id         String   @id @default(cuid())
  tenantId   String
  type       String   // whatsapp, google_calendar
  status     String   // active, inactive
  configJson String   // JSON string
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model AuditLog {
  id           String   @id @default(cuid())
  tenantId     String
  userId       String?
  action       String
  metadataJson String?
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
}
