// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Global User (Auth)
model User {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String?
  passwordHash String
  globalRole   String     @default("USER") // SUPER_ADMIN, USER
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  tenantLinks TenantUser[]
}

// Tenant / Organization
model Tenant {
  id              String   @id @default(cuid())
  slug            String   @unique
  name            String
  status          String   @default("active") // active, suspended, demo
  timezone        String   @default("America/Argentina/Buenos_Aires")
  currency        String   @default("ARS")

  // i18n
  defaultLocale   String   @default("es-AR")
  localesEnabled  String?  // JSON ["es-AR", "pt-BR"]

  // Plan & Billing
  plan            String   @default("free") // free, enterprise
  planStatus      String   @default("DEMO") // DEMO, PENDING, ACTIVE, PAST_DUE, CANCELED
  mpPreapprovalId String?  @unique
  mpSubscriptionId String? // Legacy field, keeping for safety
  planRenewsAt    DateTime?
  planActivatedAt DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users         TenantUser[]
  rubros        TenantRubro[]
  integrations  Integration[]
  waNumbers     WhatsappNumber[]
  services      Service[]
  staff         Staff[]
  contacts      Contact[]
  conversations Conversation[]
  appointments  Appointment[]
  catalogFiles  CatalogFile[]
  catalogItems  CatalogItem[]
  locations     Location[]
  messages      Message[]
  availabilityRules AvailabilityRule[]
}

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String   // "mercadopago"
  eventKey  String   @unique // resourceId or eventId
  createdAt DateTime @default(now())
}

// User role within a specific Tenant
model TenantUser {
  id        String     @id @default(cuid())
  tenantId  String
  userId    String
  role      String     @default("STAFF") // OWNER, ADMIN, STAFF, VIEWER
  createdAt DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

// Tenant Rubros (Verticals/Categories)
model TenantRubro {
  id       String @id @default(cuid())
  tenantId String
  slug     String // dentista, gym, hotel, etc
  name     String
  config   String // JSON: menu, politicas, datos_reserva, etc

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
}

// Integrations
model Integration {
  id        String @id @default(cuid())
  tenantId  String
  provider  String // "twilio_whatsapp" | "meta_whatsapp" | "google_calendar"
  config    String? // JSON
  status    String @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  waNumbers WhatsappNumber[]
}

// WhatsApp Numbers Routing
model WhatsappNumber {
  id            String @id @default(cuid())
  tenantId      String
  integrationId String
  toE164        String @unique
  label         String?
  status        String @default("active")

  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
}

// CRM Contacts
model Contact {
  id        String   @id @default(cuid())
  tenantId  String
  phoneE164 String
  name      String?
  email     String?
  locale    String?  // es-AR, pt-BR
  tags      String?  // JSON
  meta      String?  // JSON
  lastSeen  DateTime?
  createdAt DateTime @default(now())

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  appointments  Appointment[]
  messages      Message[]

  @@unique([tenantId, phoneE164])
}

// Conversations
model Conversation {
  id        String      @id @default(cuid())
  tenantId  String
  channel   String      // WHATSAPP, WIDGET, WEB
  contactId String
  state     String?     // JSON: state machine: rubro_activo, flow, step, etc
  openedAt  DateTime    @default(now())
  closedAt  DateTime?

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact  Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  messages Message[]
}

// Messages
model Message {
  id             String       @id @default(cuid())
  tenantId       String
  conversationId String
  contactId      String?
  direction      String       // IN, OUT
  body           String?      // Text content
  media          String?      // JSON
  status         String       @default("sent")
  createdAt      DateTime     @default(now())

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  contact      Contact?      @relation(fields: [contactId], references: [id])
}

// Staff / Professionals
model Staff {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  role      String?
  phone     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  availabilityRules AvailabilityRule[]
  appointments      Appointment[]
}

// Staff Availability
model AvailabilityRule {
  id          String  @id @default(cuid())
  tenantId    String
  staffId     String
  dayOfWeek   Int     // 0=Sunday
  startTime   String  // "09:00"
  endTime     String  // "18:00"
  breakStart  String?
  breakEnd    String?
  slotMinutes Int     @default(30)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  staff  Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
}

// Services
model Service {
  id          String  @id @default(cuid())
  tenantId    String
  rubroSlug   String?
  name        String
  durationMin Int
  price       Int?
  currency    String  @default("ARS")
  active      Boolean @default(true)

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
}

// Appointments
model Appointment {
  id        String     @id @default(cuid())
  tenantId  String
  contactId String
  staffId   String?
  serviceId String?
  locationId String?
  startAt   DateTime
  endAt     DateTime
  status    String     @default("PENDING") // PENDING, CONFIRMED, CANCELLED, NO_SHOW, DONE
  notes     String?
  source    String?    // whatsapp/widget/admin

  // Payment fields
  price       Int?
  currency    String?
  paymentStatus String?

  createdAt DateTime @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact  Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  staff    Staff?   @relation(fields: [staffId], references: [id])
  service  Service? @relation(fields: [serviceId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])
}

// Catalog Files
model CatalogFile {
  id         String        @id @default(cuid())
  tenantId   String
  rubroSlug  String?
  filename   String
  mime       String
  storageUrl String
  checksum   String?
  status     String        @default("UPLOADED") // UPLOADED, PROCESSING, READY, FAILED
  createdAt  DateTime      @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// Catalog Items
model CatalogItem {
  id          String  @id @default(cuid())
  tenantId    String
  rubroSlug   String?
  tipo        String  // servicio | producto | habitacion | clase | plan | tour
  name        String
  category    String?
  description String?
  price       Int?
  currency    String  @default("ARS")
  unit        String? // sesion | noche | clase | hora
  durationMin Int?
  tags        String? // JSON
  extra       String? // JSON
  active      Boolean @default(true)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// Legacy/Compatibility models (Optional, keeping Location for now)
model Location {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  address   String?
  createdAt DateTime @default(now())

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
}
